use_package("dplyr")
library(c("usethis", "devtools", "roxygen2"))
library(usethis)
library(devtools)
library(roxygen2)
use_package("dplyr")
use_package("httr")
use_package("jsonlite")
use_package("magrittr") # Pour le pipe %>%
devtools::document()
devtools::document()
devtools::load_all()
library(RespireR)
get_list_stations()
get_list_stations()
devtools::load_all()
library(RespireR)
stations <- get_list_stations()
devtools::load_all()
library(RespireR)
stations <- get_list_stations()
View(stations)
?get_list_stations
get_atmo_history(stations, c(01,08), 2024,2025)
devtools::load_all()
library(RespireR)
get_atmo_history(stations[2,], c(01,08), 2024,2025)
stations[2,]
stations[2,1]
stations[0:2,1]
get_atmo_history(stations[0:2,1], c(01,08), 2024,2025)
get_atmo_history(stations[0:2,1], c(01,34), 2024,2025)
get_atmo_history(stations[0:2,1], c(01,39), 2024,2025)
get_atmo_history(stations[0:2,1], c(01,24), 2024,2025)
get_atmo_history(stations[0:2,1], c(08), 2024,2025)
View(stations)
?get_atmo
get_atmo("FR20062", 08, 2024)
stations_filtre <- stations[1:3,]
View(stations_filtre)
get_atmo(df_stations_ref = stations_filtre)
get_atmo(df_stations_ref = stations_filtre, polluant_ids = 08)
get_atmo(station_input = stations_filtre, polluant_ids = 08)
get_atmo(station_input = stations_filtre, polluant_ids = 08, year = 2024)
get_atmo(station_input = stations_filtre, polluant_ids = "08", year = 2024)
#' Récupérer la liste des stations Atmo Auvergne-Rhône-Alpes
#'
#' @return Un data.frame contenant les colonnes id_station, nom_station, date_debut, date_fin, en_service et typologie.
#' @export
#' @importFrom jsonlite fromJSON
#' @importFrom dplyr rename_with select
get_list_stations <- function() {
url <- "https://sig.atmo-auvergnerhonealpes.fr/geoserver/opendata/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=opendata:stations_fixes_en_service&outputFormat=application/json"
message("Récupération de la liste des stations...")
data_json <- jsonlite::fromJSON(url, flatten = TRUE)
stations_df <- data_json$features |>
dplyr::rename_with(~ gsub("properties.", "", .x)) |>
dplyr::select(
.data$id_station,
.data$nom_station,
.data$date_debut,
.data$date_fin,
.data$en_service,
.data$typologie
)
return(stations_df)
}
get_atmo <- function(station_input, polluant_ids, year, df_stations_ref = NULL) {
# 1. Table de correspondance (On harmonise les IDs en caractères simples)
ref_polluants <- data.frame(
id = c("3", "39", "24", "8", "1"),
nom_polluant = c("NO2", "PM2.5", "PM10", "O3", "SO2"),
stringsAsFactors = FALSE
)
# On force polluant_ids en caractère sans le "0" devant pour matcher la table
# sprintf("%01d", as.numeric(x)) transforme "08" ou 8 en "8"
polluant_ids <- as.character(as.numeric(polluant_ids))
if (is.data.frame(station_input)) {
ids_to_fetch <- station_input$id_station
} else {
ids_to_fetch <- station_input
}
message("\n>>> Stations : ", length(ids_to_fetch), " cibles pour l'année ", year)
date_debut <- paste0(year, "-01-01")
date_fin   <- paste0(year, "-12-31")
fetch_data <- function(sid, pid) {
# On utilise l'ID numérique pour l'URL (Atmo accepte 8 ou 24)
pid_url <- as.numeric(pid)
url <- paste("https://www.atmo-auvergnerhonealpes.fr/dataviz/dataviz/mesures",
sid, pid_url, date_debut, date_fin, sep = "/")
tryCatch({
res <- httr::GET(url)
if (httr::status_code(res) != 200) return(NULL)
content_type <- httr::headers(res)$`content-type`
if (!grepl("application/json", content_type)) return(NULL)
raw_data <- jsonlite::fromJSON(httr::content(res, "text", encoding = "UTF-8"))
# Vérification que raw_data est bien un tableau de données
if (is.null(raw_data) || length(raw_data) == 0) return(NULL)
df <- as.data.frame(raw_data)
if (nrow(df) == 0) return(NULL)
df <- df %>%
dplyr::select(date = 1, valeur = 2) %>%
dplyr::mutate(
date = as.Date(as.POSIXct(date / 1000, origin = "1970-01-01", tz = "UTC")),
station = sid,
polluant = as.character(pid)
)
return(df)
}, error = function(e) return(NULL))
}
all_combinations <- expand.grid(sid = ids_to_fetch, pid = polluant_ids, stringsAsFactors = FALSE)
results_list <- mapply(fetch_data, all_combinations$sid, all_combinations$pid, SIMPLIFY = FALSE)
df_final <- dplyr::bind_rows(results_list)
if (is.null(df_final) || nrow(df_final) == 0) {
message("(!) Aucune donnée trouvée pour ces paramètres.")
return(NULL)
}
# Jointure avec les noms de polluants
df_final <- df_final %>%
dplyr::left_join(ref_polluants, by = c("polluant" = "id"))
# Jointure avec les noms de stations
if (!is.null(df_stations_ref)) {
df_final <- df_final %>%
dplyr::left_join(dplyr::select(df_stations_ref, id_station, nom_station),
by = c("station" = "id_station")) %>%
dplyr::select(date, valeur, station, nom_station, polluant, nom_polluant)
}
return(df_final)
}
#' Récupérer l'historique complet sur plusieurs années
#'
#' @param df_stations Data.frame de stations (issu de get_list_stations).
#' @param polluant_id Vecteur de codes polluants.
#' @param annee_debut Année de départ.
#' @param annee_fin Année de fin (par défaut année en cours).
#' @return Un data.frame consolidé.
#' @export
get_atmo_history <- function(df_stations, polluant_id, annee_debut, annee_fin = as.numeric(format(Sys.Date(), "%Y"))) {
if (annee_debut > annee_fin) {
stop("L'année de début ne peut pas être supérieure à l'année de fin.")
}
annees <- annee_debut:annee_fin
historique_complet <- lapply(annees, function(an) {
message("\n>>> Année : ", an)
get_atmo(station_input = df_stations, polluant_ids = polluant_id, year = an, df_stations_ref = df_stations)
})
df_final <- dplyr::bind_rows(historique_complet)
return(df_final)
}
get_atmo(station_input = stations_filtre, polluant_ids = "08", year = 2024)
devtools::load_all()
devtools::load_all()
library(reprex)
library(RespireR
)
stations <- get_list_stations()
stations_filtre <- stations[1:3,]
# Utilisez des guillemets pour les codes polluants pour être sûr
data <- get_atmo(station_input = stations_filtre, polluant_ids = "8", year = 2024, df_stations_ref = stations_df)
# Utilisez des guillemets pour les codes polluants pour être sûr
data <- get_atmo(station_input = stations_filtre, polluant_ids = c("8","39"), year = 2024, df_stations_ref = stations_df)
devtools::load_all()
library(RespireR
)
# Utilisez des guillemets pour les codes polluants pour être sûr
data <- get_atmo(station_input = stations_filtre, polluant_ids = c("8","39"), year = 2024, df_stations_ref = stations_df)
# Utilisez des guillemets pour les codes polluants pour être sûr
data <- get_atmo(station_input = stations_filtre, polluant_ids = c("08","39"), year = 2024, df_stations_ref = stations_df)
devtools::load_all()
library(RespireR)
# Utilisez des guillemets pour les codes polluants pour être sûr
data <- get_atmo(station_input = stations_filtre, polluant_ids = c("08","39"), year = 2024, df_stations_ref = stations_df)
devtools::load_all()
library(RespireR)
# Utilisez des guillemets pour les codes polluants pour être sûr
data <- get_atmo(station_input = stations_filtre, polluant_ids = c("08","39"), year = 2024, df_stations_ref = stations_df)
devtools::load_all()
library(RespireR)
# Utilisez des guillemets pour les codes polluants pour être sûr
data <- get_atmo(station_input = stations_filtre, polluant_ids = c("08","39"), year = 2024, df_stations_ref = stations_df)
devtools::load_all()
library(RespireR)
# Utilisez des guillemets pour les codes polluants pour être sûr
data <- get_atmo(station_input = stations_filtre, polluant_ids = c("08","39"), year = 2024, df_stations_ref = stations_df)
devtools::load_all()
devtools::install()
devtools::load_all()
library(RespireR)
stations <- get_list_stations()
stations <- stations[1:3,]
get_atmo(station_input = df_stations[0:3,], polluant_ids = c("08","39"), year = 2024, df_stations_ref = stations_df)
get_atmo(station_input = stations[0:3,], polluant_ids = c("08","39"), year = 2024, df_stations_ref = stations)
use_package("httr")
library(devtools)
library(usethis)
use_package("httr")
devtools:install
library(devtools)
devtools:install
devtools::install
devtools::install()
devtools::load_all()
library(RespireR)
stations <- get_list_stations()
stations <- stations[1:3,]
df_complet <- get_atmo_history(
df_stations = stations,
polluant_id = c(24,01),
annee_debut = 2024,
annee_fin = 2025
)
View(df_complet)
devtools::document()
devtools::check()
tools::showNonASCIIfile
tools::showNonASCIIfile("R/functions.R")
usethis::use_git_ignore(
".Rproj.user",
".Rhistory",
".RData",
".Ruserdata",
"renv/"
)
usethis::use_readme_md()
devtools::load_all()
devtools::install()
devtools::check()
library(RespireR)
stations <- get_list_stations()
stations <- stations[1:2,]
df <- get_atmo_history(df, "08", 2024, 2025)
df <- get_atmo_history(df, polluant_id = "08", annee_debut = 2024, 2025)
df <- get_atmo_history(df, polluant_id = "08", annee_debut = 2024, annee_fin = 2025)
df <- get_atmo_history(df_stations = df, polluant_id = "08", annee_debut = 2024, annee_fin = 2025)
?get_atmo_history
get_atmo_history(
stations,
"08",
2024,
2025)
)
get_atmo_history(
stations,
"08",
2024,
2025
)
get_atmo_history(
stations,
c(08,01,29),
2024,
2025
)
get_atmo_history(
stations,
c(08,01,39),
2024,
2025
)
library(MiniCountR)
library(devtools)
devtools::install()
devtools::document()
devtools::document()
devtools::install()
devtools::load_all
devtools::load_all()
devtools::load_all()
devtools::install()
devtools::check
devtools::check()
devtools::load_all()
devtools::clean_dll()
devtools::document()
devtools::load_all()
devtools::install()
usethis::use_mit_license()
devtools::document()
df_stations_ref <- get_list_stations()
library(devtools)
devtools::load_all()
df_stations_ref <- get_list_stations()
# 2. On filtre les stations qui nous intéressent
stations <- df_stations_ref %>%
dplyr::filter(id_station %in% c("FR20017", "FR20062"))
library(dplyr)
df_stations_ref <- get_list_stations()
# 2. On filtre les stations qui nous intéressent
stations <- df_stations_ref %>%
dplyr::filter(id_station %in% c("FR20017", "FR20062"))
df_complet <- get_atmo_bulk(
df_stations = stations,
polluant_id = c(24, 01),   # PM10 et SO2
annee_debut = 2024,
annee_fin = 2025
)
?get_atmo_bulk
devtools::load_all()
devtools::install()
devtools::document()
devtools::load_all()
